name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  type-check:
    name: Type Checking
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run mypy
        run: mypy . --ignore-missing-imports

  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: type-check
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest (functional and schema tests)
        run: pytest tests/functional tests/schema -v

      - name: Run regression tests with snapshot verification
        run: pytest tests/regression -v

  deepeval:
    name: DeepEval Evaluation
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    environment: "Default environment"
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      NASA_API_KEY: ${{ secrets.NASA_API_KEY }}
      LOGMEAL_API_KEY: ${{ secrets.LOGMEAL_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run DeepEval tests
        run: deepeval test run tests/deepeval/

      - name: Run full evaluation pipeline
        run: |
          python main.py evaluate --framework both
          # Pipeline will exit with non-zero if thresholds not met

      - name: Verify evaluation results
        run: |
          # Check that evaluation completed and results were saved
          if [ ! -d "logs" ] || [ -z "$(ls -A logs/evaluation_*.json 2>/dev/null)" ]; then
            echo "ERROR: No evaluation results found"
            exit 1
          fi
          
          # Parse latest results and verify pass conditions
          LATEST_LOG=$(ls -t logs/evaluation_*.json | head -1)
          echo "Checking results in: $LATEST_LOG"
          
          python -c "
          import json
          import sys
          import os
          
          data = json.load(open('$LATEST_LOG'))
          summary = data['summary']
          results = data['results']
          
          # Get thresholds from environment (with defaults)
          metric_threshold = float(os.environ.get('MINIMUM_METRIC_PASS_THRESHOLD', '0.7'))
          agreement_threshold = float(os.environ.get('MINIMUM_AGREEMENT_PASS_THRESHOLD', '0.8'))
          
          print(f'Configured thresholds:')
          print(f'  Metric threshold: {metric_threshold:.0%}')
          print(f'  Agreement threshold: {agreement_threshold:.0%}')
          print()
          
          # Check pass rate (already uses global thresholds in overall_passed)
          pass_rate = summary['pass_rate']
          passed = summary['passed']
          total = summary['total_test_cases']
          
          print(f'Results: {passed}/{total} test cases passed ({pass_rate:.0%})')
          
          # Show any failures
          failed_cases = [r for r in results if not r['overall_passed']]
          if failed_cases:
              print(f'\\nFailed test cases:')
              for r in failed_cases:
                  print(f'  - {r[\"test_case_id\"]}')
              print(f'\\nFAILED: {len(failed_cases)} test case(s) did not meet thresholds')
              sys.exit(1)
          
          print(f'\\nPASSED: All {total} test cases met thresholds')
          "

  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run ruff check
        run: ruff check . --ignore E501
        continue-on-error: true
